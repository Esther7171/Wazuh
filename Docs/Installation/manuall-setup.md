# Installing the Wazuh Indexer Using the Assisted Installation Method

> **Note**: You need root user privileges to run all the commands described below.

---

## Step 1: Create a Directory for Installation Files
Organize all installation files in a dedicated directory:

```bash
mkdir wazuh-install
cd wazuh-install
```

---

## Step 2: Initial Configuration
Set up your deployment configuration, generate SSL certificates, and create secure random passwords.

### Download the Installation Assistant and Configuration File:
```bash
curl -sO https://packages.wazuh.com/4.11/wazuh-install.sh
curl -sO https://packages.wazuh.com/4.11/config.yml
```

### Edit `config.yml`:
Update the node names and IP addresses for your Wazuh server, indexer, and dashboard. Modify the `nodes` section as needed:
```
nano config.yml
```

```yaml
nodes:
  # Wazuh indexer nodes
  indexer:
    - name: node-1
      ip: "10.10.10.10"
    #- name: node-2
    #  ip: "<indexer-node-ip>"
    #- name: node-3
    #  ip: "<indexer-node-ip>"

  # Wazuh server nodes
  server:
    - name: wazuh-1
      ip: "10.10.10.10"
    #  node_type: master
    #- name: wazuh-2
    #  ip: "<wazuh-manager-ip>"
    #  node_type: worker

  # Wazuh dashboard nodes
  dashboard:
    - name: dashboard
      ip: "10.10.10.10"
```

---

## Step 3: Configure for Static Public IP (Optional)
If using a static public IP, modify the script by commenting out or deleting the following block to allow public IP usage:

```bash
for ip in "${all_ips[@]}"; do
    isIP=$(echo "${ip}" | grep -P "^[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}$")
    if [[ -n "${isIP}" ]]; then
        if ! cert_checkPrivateIp "$ip"; then
            common_logger -e "The IP ${ip} is public."
            exit 1
        fi
    fi
done
```
<div align="center">
  <img src="https://github.com/user-attachments/assets/84040969-831b-414e-8843-5b35dad2308a"></img>
</div>

---

## Step 4: Generate Configuration Files
Run the following command to create the Wazuh cluster key, SSL certificates, and secure passwords:

```bash
bash wazuh-install.sh --generate-config-files
```

---

## Step 5: Install Wazuh Indexer Nodes

### Install and Configure the Wazuh Indexer:
Run the script for each node (e.g., `node-1`):

> **Note**: Ensure `wazuh-install-files.tar` from the initial configuration is in your working directory.

```bash
bash wazuh-install.sh --wazuh-indexer node-1
```

---

## Step 6: Initialize the Cluster
### Start the Cluster:
Run the command on any Wazuh indexer node to load the new certificates and initialize the cluster:

```bash
bash wazuh-install.sh --start-cluster
```

> **Note**: This step is only needed once. No need to run it on every node.

---

## Step 7: Test the Cluster Installation
### Retrieve the Admin Password:
Save the admin password to `/root/pass.txt`:

```bash
tar -axf wazuh-install-files.tar wazuh-install-files/wazuh-passwords.txt -O | grep -P "\'admin\'" -A 1 | tee -a /root/pass.txt
```

### Verify Installation:
Replace `<ADMIN_PASSWORD>` and `<WAZUH_INDEXER_IP>` with your values and run:

```bash
curl -k -u admin:<ADMIN_PASSWORD> https://<WAZUH_INDEXER_IP>:9200
```

Expected Output:
```json
{
  "name": "node-1",
  "cluster_name": "wazuh-cluster",
  "cluster_uuid": "095jEW-oRJSFKLz5wmo5PA",
  "version": {
    "number": "7.10.2",
    "build_type": "rpm",
    "build_hash": "db90a415ff2fd428b4f7b3f800a51dc229287cb4",
    "build_date": "2023-06-03T06:24:25.112415503Z",
    "build_snapshot": false,
    "lucene_version": "9.6.0",
    "minimum_wire_compatibility_version": "7.10.0",
    "minimum_index_compatibility_version": "7.0.0"
  },
  "tagline": "The OpenSearch Project: https://opensearch.org/"
}
```

### Check Cluster Status:
Replace `<WAZUH_INDEXER_IP>` and `<ADMIN_PASSWORD>` and execute:

```bash
curl -k -u admin:<ADMIN_PASSWORD> https://<WAZUH_INDEXER_IP>:9200/_cat/nodes?v
```

---

## Step 8: Install the Wazuh Server
Run the Wazuh installation assistant with the option `--wazuh-server` followed by the node name to install the Wazuh server. The node name must match the one used in `config.yml` for the initial configuration (e.g., `wazuh-1`).

> **Note**: Ensure `wazuh-install-files.tar` from the initial configuration is in your working directory.

```bash
bash wazuh-install.sh --wazuh-server wazuh-1
```

---

## Step 9: Install the Wazuh Dashboard
Run the Wazuh installation assistant with the option `--wazuh-dashboard` followed by the node name to install and configure the Wazuh dashboard. The node name must match the one used in `config.yml` for the initial configuration (e.g., `dashboard`).

> **Note**: Ensure `wazuh-install-files.tar` from the initial configuration is in your working directory.

```bash
bash wazuh-install.sh --wazuh-dashboard dashboard
```

## Step 10: Retrieve All Generated Passwords
Find all passwords generated by the Wazuh installation assistant in the `wazuh-passwords.txt` file inside the `wazuh-install-files.tar` archive. To print them:

```bash
tar -O -xvf wazuh-install-files.tar wazuh-install-files/wazuh-passwords.txt | tee -a /root/pass.txt
```

---

## Step 11: Access the Web Panel
Use the IP address provided during the configuration to access the Wazuh web panel.

## Step 12: Update
```
sudo apt update -y && sudo apt upgrade -y
```
> **Recommended Action**: Disable Wazuh Updates.
> We recommend disabling the Wazuh package repositories after installation to prevent accidental upgrades that could break the environment.
> Execute the following command to disable the Wazuh repository:

```
sed -i "s/^deb /#deb /" /etc/apt/sources.list.d/wazuh.list
apt update
```
---

## Creating a Bash Script to Restart All Wazuh Services

To create a script that restarts all necessary Wazuh services, follow these steps:

1. Open a terminal and create the script file:
```bash
sudo nano /usr/local/bin/restart-wazuh
```

2. Add the following script content:
```bash
#!/bin/bash

echo "___________________________"
echo
echo -e "\e[1;5;7;43m Starting Wazuh Indexer\e[0m"
echo "___________________________"

sudo systemctl daemon-reload
sudo systemctl enable wazuh-indexer
sudo systemctl start wazuh-indexer

echo "___________________________"
echo
echo -e "\e[1;5;7;43m Starting Wazuh Manager\e[0m"
echo "___________________________"

sudo systemctl enable wazuh-manager
sudo systemctl start wazuh-manager

echo "___________________________"
echo
echo -e "\e[1;5;7;43m Starting File beat\e[0m"
echo "___________________________"

sudo systemctl enable filebeat
sudo systemctl start filebeat


echo "___________________________"
echo
echo -e "\e[1;5;7;43m Starting Wazuh Dashboard\e[0m"
echo "___________________________"

sudo systemctl enable wazuh-dashboard
sudo systemctl start wazuh-dashboard

echo "___________________________"
echo
echo -e "\e[1;5;7;43m Starting SSH Service\e[0m"
echo "___________________________"

sudo systemctl restart ssh


echo "__________________"
echo
echo -e "\e[1;5;7;43m Done\e[0m"
echo "__________________"
```

3. Save the file (`CTRL + X`, then `Y`, then `ENTER`).

4. Give execution permission to the script:
```bash
sudo chmod +x /usr/local/bin/restart-wazuh
```

5. Now, you can restart all Wazuh services anytime using:
```bash
sudo restart-wazuh
```
